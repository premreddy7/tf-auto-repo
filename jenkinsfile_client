def getAccountID() 
{
    if ( "${GIT_BRANCH}" == "dev" ) 
    {
       return "${DEV_AWS_ACCOUNT_ID}"
    }
    else if ( "${GIT_BRANCH}" == "test" ) 
    {
        return "${TEST_AWS_ACCOUNT_ID}"
    }
    else 
    {
       return ""
    }
}

pipeline 
{ 
  agent 
  {
    kubernetes 
    {
        yaml """
            apiVersion: v1
            kind: Pod
            spec:
                # Service Account Name to insert will be provided once previous steps are completed (refer to step 2)
                serviceAccountName: ospr-coin
                restartPolicy: Never
                containers:
                # Add more containers to complete the job
                - name: awscli
                  image: mikesir87/aws-cli:2.0.25
                  command: ['cat']
                  tty: true
                - name: terraform
                  image: hashicorp/terraform:0.12.29
                  command: ['cat']
                  tty: true
        """
    }
  }
   
   environment 
   {
    AWS_ACCOUNT_ID = getAccountID()
    IAM_ROLE="coin_devops_cbc_master_role"
   }

   stages 
   {
     stage('AWS-Config')
     { 
        steps 
        {
            container('awscli')
            {
            
                sh """
                     echo \$(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
                     \$(aws sts assume-role --role-arn arn:aws-us-gov:iam::\${AWS_ACCOUNT_ID}:role/\${IAM_ROLE} \
                     --role-session-name terraform --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \
                     --output text)) | tr ' ' '\n' > \${WORKSPACE}/.aws-creds
                """
            }
        }
     }
     
     stage('Terraform Init-Validate-Plan') 
     { 
        steps 
        {             
            container('terraform')
            {
            
                sh """
                    set -a
                    source \${WORKSPACE}/.aws-creds
                    set +a
                    
                    # Terraform commands to initialize, validate and run a plan of terraform code 
                    cd terraform/env/${GIT_BRANCH}
                    terraform init -backend-config="key=terraform-tfstate/env/${GIT_BRANCH}/redshift/terraform.tfstate" -no-color
                    terraform validate -no-color
                    terraform plan  -no-color
                """
            
            }
        }
     }     

     stage('Waiting for Approvals') 
     {
        steps
        {
            input('Plan Validated? Please approve to create resources in AWS?')	  
        }
     }    
     
     
     stage('Terraform Apply') 
     { 
        steps 
        {             
            container('terraform')
            {
                sh """
                    set -a 
                    source \${WORKSPACE}/.aws-creds
                    set +a
    
                    # Run terraform apply to create resources on target cloud
                    cd terraform/env/${GIT_BRANCH} 
                    terraform apply -auto-approve -no-color
                """
            }
        }
     } 
   }
}
